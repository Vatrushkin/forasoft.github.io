---
layout: post
title:  "Вебинар на&nbsp;WebRTC без&nbsp;медиасерверов"
date:   2017-01-24 00:00:00 +0300
permalink: /chain-webrtc/
tags: [webrtc, videochat, p2p]
keywords: [webrtc, videochat, p2p]
author: [davudov, pavlov]
---
Возможно&nbsp;ли реализовать видео трансляцию тысяче пользователей без медиа серверов? [WebRTC](/webrtc-in-plain-russian)  казалось&nbsp;бы подходит для этого&nbsp;&mdash; peer to&nbsp;peer технология, клиенты передают данные друг другу без посредников. Но&nbsp;если мы&nbsp;подключим всех желающих посмотреть прямой эфир напрямую к&nbsp;источнику, то&nbsp;клиент просто не&nbsp;выдержит такой нагрузки и&nbsp;трафика.

![](/assets/posts/chain-webrtc/3.jpg)

Нам придется ограничить число исходящих видеопотоков. А&nbsp;чтобы видео дошло до&nbsp;всех клиентов, мы&nbsp;попробуем соединить их&nbsp;между собой по&nbsp;цепочке.
Мы&nbsp;оценим возможность применения соединения по&nbsp;цепочке в&nbsp;реальных проектах, ориентируясь на&nbsp;качество картинки, задержки сигнала и&nbsp;его восстановления в&nbsp;случае разрыва одного из&nbsp;узлов цепочки.


<!--more-->

## Как реализовывать вебинар на&nbsp;WebRTC? ##
Чаще всего видеопоток в&nbsp;вебинарах передают от&nbsp;ведущего через сервер к&nbsp;зрителям. Или напрямую от&nbsp;ведущего к&nbsp;ограниченному числу зрителей. Мы&nbsp;же предлагаем схему: Ведущий&nbsp;&mdash; Зрители&nbsp;&mdash; Зрители
Ведущий&nbsp;&mdash; Сервер&nbsp;&mdash; Зрители

![](/assets/posts/chain-webrtc/1.jpg)
Pисунок 1: Организация вебинара с использованием медиа сервераx  

Перед нами самая популярная реализация. Нагрузка на&nbsp;ведущего и&nbsp;зрителей в&nbsp;такой схеме минимальна. Все проходит через сервер.

Плюсы:

* Потенциально, стабильное качество видео&nbsp;&mdash; только один посредник между ведущим и&nbsp;зрителями.

Минусы:

* Большая нагрузка на&nbsp;медиа сервер.


### Ведущий&nbsp;&mdash; Зрители ###

![](/assets/posts/chain-webrtc/2.jpg)
Pисунок 2: Организация вебинара с подключением зрителей напрямую к ведущему  

В&nbsp;этой реализации мы&nbsp;экономим на&nbsp;сервере&nbsp;&mdash; вся нагрузка ложится на&nbsp;ведущего вебинара. Он&nbsp;отдает видеопоток каждому клиенту отдельно и&nbsp;требования к&nbsp;пропускной способности канала прямо пропорциональны количеству клиентов. Схема подходит для ограниченного числа зрителей. Уже после пятого соединения у&nbsp;многих пользователей начнутся проблемы.

Плюсы:

* Не&nbsp;нужен медиа сервер.
* Простота реализации.
* Минимальное время задержки&nbsp;&mdash; только время передачи данных от&nbsp;организатора к&nbsp;зрителям.

Минусы:

* Максимальное количество зрителей ограничено пропускной способностью канала ведущего.

### Ведущий&nbsp;&mdash; Зрители&nbsp;&mdash; Зрители (Цепочка) ###

![](/assets/posts/chain-webrtc/3.jpg)
Pисунок 3: Организация вебинара с использованием промежуточный узлов-зрителей  

В&nbsp;реализации цепочкой Ведущий вебинара транслирует свои данные первым N1&nbsp;зрителям, эти зрители ретранслируют поток Ведущего следующим N2&nbsp;зрителям и&nbsp;так далее. Мы&nbsp;получаем: минимальную нагрузку на&nbsp;сервер, как в&nbsp;схеме Ведущий&nbsp;&mdash; Зрители, и&nbsp;возможность иметь большое число клиентов, как в&nbsp;схеме Ведущий&nbsp;&mdash; Сервер&nbsp;&mdash; Зрители.

Плюсы:

* Не&nbsp;нужен медиа сервер.
* Нагрузка на&nbsp;трансляцию равномерно распределяется по&nbsp;участникам.

Минусы:

* C&nbsp;ростом цепочки клиентов увеличивается задержка и&nbsp;ухудшается качество.
* Сложность реализации приемлемой защиты от&nbsp;отключения узлов.

#### Как реализовать цепочку? ####
Для реализации цепочки необходимо обработать две ситуации: подключение и&nbsp;отключение пользователя.
При наличии у&nbsp;ведущего свободных слотов новый зритель создает соединение с&nbsp;ним, иначе со&nbsp;свободным родителем. Сам пользователь при этом добавляется в&nbsp;список свободных родителей.
Очевидной проблемой становится отключение одного из&nbsp;родителей.

Существует несколько способов решения.

##### Способ &#8470;&nbsp;1: #####

![](/assets/posts/chain-webrtc/4.gif)
Pисунок 4: Восстановление подключения  

Первый способ самый простой. При подключении нового зрителя ему назначается свободный родитель, запасные каналы в&nbsp;данной реализации отсутствуют. После того как родитель покинул комнату, его зрителям по&nbsp;цепочке необходимо найти нового родителя. В&nbsp;данном случае у&nbsp;зрителей на&nbsp;промежуток времени от&nbsp;разрыва со&nbsp;старым родителем до&nbsp;установления соединения с&nbsp;новым пропадает картинка с&nbsp;видеопотоком (1-5 секунд в&nbsp;зависимости от&nbsp;параметров подключения участников).

Плюсы:

* Простота реализации.

Минусы:

* При отключении родителя пропадает картинка у&nbsp;всех его зрителей на&nbsp;несколько секунд.
* Возможна потеря части видеотрансляции из-за разницы в&nbsp;задержках.
* Для каждого зрителя в&nbsp;цепочке после отключившегося родителя необходимо искать нового родителя.

##### Способ &#8470;&nbsp;2: #####

![](/assets/posts/chain-webrtc/5.gif)
Pисунок 5: Восстановление подключения c использованием запасного соединения с медиа сервером  

При подключении нового пользователя устанавливаем дублирующее соединение с&nbsp;сервером. Когда родитель покидает комнату, все его зрители переключаются на&nbsp;запасной медиа канал с&nbsp;сервером, пока ищется новый родитель.

Плюсы:

* При отключении родителя картинка пропадает на&nbsp;небольшой промежуток времени.

Минусы:

* При отключении родителя значительно возрастает нагрузка на&nbsp;сервер.
* Возможна потеря части трансляции из-за разницы в&nbsp;задержках.
* Необходим медиа сервер для дублирующих соединений.

##### Способ &#8470;&nbsp;3: ######

![](/assets/posts/chain-webrtc/6.gif)
Pисунок 6: Восстановление подключения c использованием запасного соединения с медиа сервером только для прямых потомков  

Теперь когда родитель покидает комнату, только его прямые зрители начинают искать новый источник и&nbsp;включают передачу данных с&nbsp;дублирующего соединения.

Плюсы:

* Необходимо искать нового родителя только следующем в&nbsp;цепочке зрителем.
* Меньшая нагрузка на&nbsp;сервер по&nbsp;сравнению с&nbsp;предыдущим вариантом.

Минусы:

* Возможна потеря части трансляции из-за разницы в&nbsp;задержках.
* Реализация сложнее чем у&nbsp;предыдущего варианта.

##### Способ &#8470;&nbsp;4: #####


![](/assets/posts/chain-webrtc/8.gif)
Pисунок 7: Восстановление подключения c использованием запасного соединения c соседом родителя  

При подключении пользователь устанавливает соединение с&nbsp;двумя родителями.
В&nbsp;этом случае, когда родитель покидает комнату, прямые потомки начинают искать нового родителя и&nbsp;включают дублирующее соединение (пока устанавливается новое).

Плюсы:

* При отключении родителя картинка у&nbsp;зрителей пропадает на&nbsp;минимальное время.
* Минимальная нагрузка на&nbsp;сервер.

Минусы:

* Увеличивается нагрузка на&nbsp;родителя в&nbsp;момент активации подключенных к&nbsp;нему дублирующих соединений.
* Сложность реализации.

Мы&nbsp;остановились на&nbsp;первом способе, как наиболее простом в&nbsp;реализации.  

## Устройство Frontend ##

Пользователь при заходе видит страницу с&nbsp;полем для ввода названия комнаты и&nbsp;кнопками для создания и&nbsp;подключения к&nbsp;ней.
Ведущий отправляет событие о&nbsp;создании комнаты на&nbsp;сервер, запрашивает доступ к&nbsp;микрофону и&nbsp;видеокамере и&nbsp;ждет запрос на&nbsp;создание PeerConnection.
Первые участники подключаются к&nbsp;ведущему пока не&nbsp;закончится квота сервера на&nbsp;подключение к&nbsp;ведущему, последующие к&nbsp;другим участникам.
Участник отправляет событие на&nbsp;сервер о&nbsp;подключении к&nbsp;комнате, получает и&nbsp;отправляет SDP и&nbsp;Ice Candidate. После чего получает и&nbsp;выводит видеопоток от&nbsp;родителя.
Отличие в&nbsp;поведении участника от&nbsp;ведущего в&nbsp;том, что он&nbsp;не&nbsp;запрашивает доступ к&nbsp;видеокамере и&nbsp;микрофону и&nbsp;не&nbsp;получаем с&nbsp;них медиапоток. А&nbsp;также передает видеопоток родителя дальше.
При отключении родителя участники получают сообщение о&nbsp;необходимости установить новое соединение.

## Устройство Backend ##
Backend часть состоит из&nbsp;сокет сервера, который выполняет роль сигнального сервера.
Когда пользователь создает комнату, он&nbsp;становится ведущим вебинара (далее ведущий) и&nbsp;первым свободным стримером-родителем (далее родителем).
При подключении нового участника ему назначается первый доступный родитель, а&nbsp;сам участник добавляется в&nbsp;список доступных.
При отключении участника его детям отправляется событие о&nbsp;том, что их&nbsp;родитель вышел.

## Задержки и&nbsp;качество видеотрансляции ##
Для проверки качества и&nbsp;задержек видеотрансляции мы&nbsp;провели тестовый вебинар.
Зрители были распределены по&nbsp;городу Санкт-Петербургу. Были использованы различные способы подключения к&nbsp;интернету: Wi-Fi, витая пара, LTE. Ведущий был подключен по&nbsp;LTE. Число в&nbsp;левом верхнем углу на&nbsp;результатах указывает на&nbsp;количество узлов между источником(включая сам источник) и&nbsp;зрителем, то&nbsp;есть 0&nbsp;число&nbsp;&mdash; сам источник, 1&nbsp;&mdash; зритель получает трансляцию напрямую от&nbsp;источника, 2&nbsp;&mdash; зритель получает трансляцию от&nbsp;зрителей с&nbsp;числом 1&nbsp;и&nbsp;т.д..
Результаты трансляции:

![](/assets/posts/chain-webrtc/9.gif)
Pисунок 8: Видеопоток с одним промежуточным звеном  

На&nbsp;уровне 2&nbsp;качество трансляции на&nbsp;хорошем уровне, минимальные задержки, близко по&nbsp;результатом к&nbsp;классической схеме использованием медиа сервера, так как всего 1&nbsp;посредник между источником и&nbsp;зрителем.

![](/assets/posts/chain-webrtc/10.gif)
Pисунок 9: Видеопоток с четырмя промежуточными звеньями  


На&nbsp;уровне 5&nbsp;уже заметно падение качество видео, задержки варьируется от&nbsp;1-2 секунд в&nbsp;большую часть времени.

![](/assets/posts/chain-webrtc/11.gif)
Pисунок 10: Видеопоток с семью промежуточными звеньями  

Потеря качества трансляции и&nbsp;задержки на&nbsp;уровне 8. При таком уровне потери качества проведения трансляции не&nbsp;представляется возможным.

Максимальное количество зрителей зависит от&nbsp;нескольких факторов: как расположены зрители географически, изначальное разрешение видеопотока, пропускная способность интернет-каналов участников трансляции. На&nbsp;основе полученных результатов для приемлемого качество мы&nbsp;можем взять 5&nbsp;уровней посредников и&nbsp;3&nbsp;ретрансляции в&nbsp;каждом узле (такое число ретрансляций которое должны выдержать даже самые слабые современные компьютеры и&nbsp;минимальные интернет-каналы). С&nbsp;такими числами, максимальное число зрителей равно 273.

## Заключение ##
По&nbsp;результатам тестов делаем вывод, что реализация соединения цепочкой возможна и&nbsp;будет работать для 10-300&nbsp;зрителей, в&nbsp;зависимости от&nbsp;требований к&nbsp;качеству видео и&nbsp;изначальному разрешению.
Также этот подход можно комбинировать с&nbsp;использованием медиа сервера, минимизируя на&nbsp;нем нагрузку.
Например, мы&nbsp;транслируем видео через медиасервер 1000&nbsp;зрителям. Добавив хотя&nbsp;бы один уровень цепочки, мы&nbsp;уменьшим трафик на&nbsp;сервер минимум в&nbsp;два раза. При этом потеря качества на&nbsp;одном уровне будет незначительной.
